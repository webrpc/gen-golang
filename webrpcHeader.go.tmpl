{{define "webrpcHeader"}}
const WebrpcHeader = "Webrpc"

const WebrpcHeaderValue = "{{ .WebrpcHeader }}"

type WebrpcGenVersions struct {
    WebrpcGenVersion string
    CodeGenName string
    CodeGenVersion string
    SchemaName string
    SchemaVersion string
}

func VersionFromHeader(h http.Header) (*WebrpcGenVersions, error) {
    if h.Get(WebrpcHeader) == "" {
        return nil, fmt.Errorf("header is empty or missing")
    }

    versions, err := parseWebrpcGenVersions(h.Get(WebrpcHeader))
    if err != nil {
        return nil, fmt.Errorf("webrpc header is invalid: %w", err)
    }

    return versions, nil
}

func parseWebrpcGenVersions(header string) (*WebrpcGenVersions, error) {
    versions := strings.Split(header, ";")
    if len(versions) < 3 {
        return nil, fmt.Errorf("expected at least 3 parts while parsing webrpc header: %v", header)
    }

    _, webrpcGenVersion, ok := strings.Cut(versions[0], "@")
    if !ok {
        return nil, fmt.Errorf("webrpc gen version could not be parsed from: %s", versions[0])
    }

    tmplTarget, tmplVersion, ok := strings.Cut(versions[1], "@")
    if !ok {
        return nil, fmt.Errorf("tmplTarget and tmplVersion could not be parsed from: %s", versions[1])
    }

    schemaName, schemaVersion, ok := strings.Cut(versions[2], "@")
    if !ok {
        return nil, fmt.Errorf("schema name and schema version could not be parsed from: %s", versions[2])
    }

    return &WebrpcGenVersions{
        WebrpcGenVersion: webrpcGenVersion,
        CodeGenName: tmplTarget,
        CodeGenVersion: tmplVersion,
        SchemaName: schemaName,
        SchemaVersion: schemaVersion,
    }, nil
}
{{end}}